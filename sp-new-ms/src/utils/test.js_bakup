/*
i Copyright (c) 2016 by Tecnotree Ltd. All Rights Reserved.
*/
"use strict";

const Promise = require("bluebird");
const events = require('events');
const _ = require('lodash');
const uuid = require('uuid');

const common = require('@tt-asa/common');
const log = _.invoke(common, "logger");

const config = require('../config/config.js');
const lib = require("../lib");
const main = require('../main');
let waitTimeMsecs = 1000;

let handleCall = main.handleCall;


let options = {
	"clientId": "sp-new-ms-test",
	"groupId": "sp-new-ms-test-group"
};

let topic = _.get(config, 'kafka.producer.topic') ;

/**
 * Generic Ok Test case core
 * @param done - mocha test case done
 * @param createRequesteMessageCb  - function(requestId) { ,,, return requesteMessageObj;}
 * @param validateResponseMesaageCb  - function(responseMasageObj) { ,,, should series }
 */

function writeCDR ( cdrMessageObj ) {
		let msgObj = {
			"jsonBody": cdrMessageObj
		};
		_.invoke(common,
				"gen-ms.cast",
				topic,
				function(correlationId) {
					let payloadParts = {};
					payloadParts.msgObj = msgObj;
					return payloadParts;
				},
				options
		)	
	 .then(function() {
			log.debug("CDR generated successfully");
		})
		.catch(function(e) {
		   log.debug('Failed to generate CDR, error: ' + e.toString());
		});

			return;
};


/*
function tcReadCdr(done, createRequestPayloadPartsCb, validateResponseMessageCb) {
  log.debug("Started the test case...");
  // create gen-ms params let options = { "clientId": "sp-new-ms-test", "groupId": "sp-new-ms-test-group" }; //let topic = _.get(config, 'kafka.producer.topic'); let reqRespTopicPair = [ _.get(config, 'kafka.consumer.topic'), _.get(config, 'kafka.producer.topic') ]; _.invoke(common, "gen-ms.call", // params reqRespTopicPair, createRequestPayloadPartsCb, validateResponseMessageCb, options) //consume(topic, createRequestPayloadPartsCb, validateResponseMessageCb, options)
  .then(()=>{
    done();
    return "ok";
  })
  .catch(e => {
    log.error('Caught error: ' + e.toString());
    done(e);
  });
};
*/
/*
function tcReadCdr(done, createRequestPayloadPartsCb, validateResponseMessageCb) {
  log.debug("Started the test case...");
  // create gen-ms params
  let options = {
    "clientId": "sp-new-ms-test",
    "groupId": "sp-new-ms-test-group"
  };
	let topic = _.get(config, 'kafka.producer.topic');
	log.debug("tzf" + topic);

  consume(topic, createRequestPayloadPartsCb, validateResponseMessageCb, options)
  .then(()=>{
    done();
    return "ok";
  })
  .catch(e => {
    log.error('Caught error: ' + e.toString());
    done(e);
  });
};
*/
/**
function tcCore(done, createRequestPayloadPartsCb, validateResponseMessageCb) {
  log.debug("Started the test case...");
  // create gen-ms params
  let options = {
    "clientId": "sp-new-ms-test",
    "groupId": "sp-new-ms-test-group"
  };
  let reqRespTopicPair = [
    _.get(config, 'kafka.consumer.topic'),
    _.get(config, 'kafka.producer.topic')
  ];
  // Call sp-new-ms micro service via gen-ms.call()
  //  causing kafka query-request/query-response message exchange
  _.invoke(common, "gen-ms.call",
    // params
    reqRespTopicPair, createRequestPayloadPartsCb, validateResponseMessageCb, options
  )
  .then(()=>{
    done();
    return "ok";
  })
  .catch(e => {
    log.error('Caught error: ' + e.toString());
    done(e);
  });
};
*/

///////////////////////
// Utils
///////////////////////
let testOwnerId = process.env.TESTOWNERID || "61932220";
let testMemberId = process.env.TESTMEMBERID || "61932230";
log.debug("testOwnerId: " + testOwnerId);
log.debug("testMemberId: " + testMemberId);

let testOwnerIdPerfix = testOwnerId.slice(0, -1);
let testMemberIdPerfix = testMemberId.slice(0, -1);
log.debug("testOwnerIdPerfix: " + testOwnerIdPerfix);
log.debug("testMemberIdPerfix: " + testMemberIdPerfix);

let testOwnerId1 = testOwnerIdPerfix + "0";
let testOwnerId2 = testOwnerIdPerfix + "1";
let testOwnerId3 = testOwnerIdPerfix + "2";
log.info("==============================");
log.info("testOwnerId1: " + testOwnerId1);
log.info("testOwnerId2: " + testOwnerId2);
log.info("testOwnerId3: " + testOwnerId3);
log.info("==============================");

let testMemberId1 = testMemberIdPerfix + "0";
let testMemberId2 = testMemberIdPerfix + "1";
let testMemberId3 = testMemberIdPerfix + "2";
log.info("testMemberId1: " + testMemberId1);
log.info("testMemberId2: " + testMemberId2);
log.info("testMemberId3: " + testMemberId3);
log.info("==============================");



function getTestSpDef() {
  return {
    "name": "test-sharedPlan",
    "unitType": 53,
    "allowance": 1024000,
    "packageDefId": 1004,
    "purchaseCost": 50000,
    "renewalCost": [10000],
    "additionalMemberCost": [5000],
    "validityPeriod": "m"
  };
};

function getTestSp(testSpDefObj) {
  return {
    'defId': testSpDefObj['id'],
    'ownerId': testOwnerId1
  };
};

function getTestMA() {
  return {
    "planId": -1,
    "memberId": testMemberId1,
    "allowanceShareType": "percent",
    "shareValue": 20
  };
};

function createTestData() {
  log.debug("createTestData: called ");
  return Promise.resolve(lib.db.model('SharedPlanDefinition').create(getTestSpDef))
  .then(spDefObj => {
    return lib.db.model('SharedPlanDefinition').saveAsync(spDefObj)
    .then( () => {
      return spDefObj;
    });
  })
  .then(spDefObj => {
    let testSp = getTestSp(spDefObj);
    return Promise.resolve(lib.db.model('SharedPlan').create(testSp))
    .then(spObj => {
      return lib.db.model('SharedPlan').saveAsync(spObj)
      .then( () => {
        return ([spDefObj, spObj]);
      });
    });
  })
  .then(objs => {
    let spDefObj = objs[0];
    let testSp = objs[1];
    let testMa = getTestMA();
    testMa.defId = objs[0].id;
    testMa.planId = objs[1].id;
    return Promise.resolve(lib.db.model('MemberAllowanceShare').create(testMa ))
    .then(maObj => {
      return lib.db.model('MemberAllowanceShare').saveAsync(maObj)
      .then( () => {
        return ([spDefObj, testSp, [maObj]]);
      });
    });
  });
};

function genericBlankDb(model) {
  log.debug("genericBlankDb: called ");
  let criteria = null;
  return model.findAllAsync(criteria)
  .then(function (objs) {
    log.debug("genericBlankDb: objs= " + JSON.stringify(objs));
    if (!_.isArray(objs) || (objs.length === 0)) {
      return "ok";
    }
    let rmps = _.map(objs, obj => {
      model.removeAsync(obj);
    });
    return Promise.all(rmps);
  })
  .catch(e => {
    log.debug("genericBlankDb: err = " + JSON.stringify(e));
  });
};

function blankSpDb() {
  return genericBlankDb(lib.db.model('SharedPlan'));
}

function blankMaDb() {
  return genericBlankDb(lib.db.model('MemberAllowanceShare'));
};

function blankSpDefDb() {
  return genericBlankDb(lib.db.model('SharedPlanDefinition'));
};

function blankDb(db) {
  return new Promise((resolve, reject) => {
    db.send_command("flushdb", (err, data) => {
      if(err) {
        log.debug("blankdb() error occured : error = " + JSON.stringify(err));
        reject(err);
      } else {
        resolve();
      }
    });
  });
  // return blankMaDb().then(() => {
  //   return blankSpDb().then(() => {
  //     return blankSpDefDb();
  //   });
  // });
};

//function tcCore(done, createRequestMsgObjCb, validateResponseMessageObjCb, cdrMessage) {
function tcCore(done, cdrMessage) {
  log.debug("Started the test case...");
   return Promise.delay(waitTimeMsecs).then( function() {
      return writeCDR().then( function() {
         return "ok";
      });
   })
  .delay(waitTimeMsecs).then( function() {
		done();
	});
 //});

  let producerReady = new Promise( function(resolve, reject)  {
	      prodReadyEventEmitter.on('connect.received',  function () {
				        resolve(writeCDR(sampleCDR));
	      });
  });

 db.on('connect', function() {
		dbReadyEventEmitter.emit('connect.received');
  dbReady.then ( () => {
  done();
 });
														     });
																   });


	
	let produce
	let replyEventEmitter = new events.EventEmitter();
	let replyReceived = new Promise(function (resolve) {
		replyEventEmitter.on('cdr.received', function (sbqsResponseMessage) {
			resolve(sbqsResponseMessage);
		});
	});
  log.debug("Reply promise created.");
	
  let requestId = uuid.v4();
	log.debug("Request id generated:" + requestId.toString());
	let consumerOptions = _.pick(usedOptions, ["autoCommit", "fetchMaxWaitMs", "fetchMaxBytes", "groupId", "offset", "fromOffset"]);
	  if(!consumerOptions.groupId) {
	     consumerOptions.groupId = ("gen-ms-server-group-" + (process.pid).toString());
	  }
	let consumer = ck.createConsumer(client, cdrTopic, consumerOptions);

  //let client = createTestKafkaClient(requestId.toString());
  log.debug("Kafka client created.");
	/*
  let producer = createTestKafkaProducer(client );
  log.debug("Kafka producer created.");
  let consumer = createTestKafkaConsumer(client, siteId);
  log.debug("Kafka consumer created.");
  let requestMsgObj = createRequestMsgObjCb(requestId);
  let siteIdStr = ('00' + siteId.toString()).slice(-2);
  let siteIdTopicPostfix = "." + siteIdStr;
  let topic = config.kafka.consumer.topic + siteIdTopicPostfix;

  let payloads = [{
		"topic": topic,
		"messages": [JSON.stringify(requestMsgObj)]
  }];
  consumer.on('message', function(message) {
		log.debug("+++Kafka message received+++:" + JSON.stringify(message));
	  let sbqsResponseMessage = JSON.parse(message.value);
	  if (sbqsResponseMessage.requestId === requestId) {
			replyEventEmitter.emit('query.response.received', sbqsResponseMessage);
		}

	});
  let producerReady = new Promise(function(resolve) {
		producer.on('ready', function() {
			resolve("ok");
		});
	});
	producer.on('error', function() {});
	consumer.on('error', function() {});

	log.debug("Waiting for producer to be ready");
	producerReady.then( function() {
		log.debug("Producer ++ready++");
		log.debug("Sending kafka payloads: " + JSON.stringify(payloads));
		producer.sendAsync(payloads).then( function() {
			log.debug("Kafka payloads has been sent okay!");
			return replyReceived;
		})
		.then(function(sbqsResponseMessage) {
		  log.debug("Validating the received query response message...");
		  validateResponseMessageObjCb(sbqsResponseMessage);
		  consumer.close(true, function() {});
		  client.close(function() {});
			done();
		})
		.timeout(
		  timeoutMsecs,
		  "Operation timed out"
		)
		.catch(function(e) {
		  log.debug('Caght error: ' + e.toString());
		  log.debug('mute consumer & return to error to test-runner');
		  consumer.close(true, function() {});
		  client.close( function() {});
			done(e);
     });
	});
	*/
} //tcCore


// EXPORTS
module.exports.tcCore = tcCore;
//module.exports.tcReadCdr = tcReadCdr;
//module.exports.tcCoreExpectTimeoutError = tcCoreExpectTimeoutError;
module.exports.blankDb = blankDb;
module.exports.writeCDR = writeCDR;
module.exports.createTestData = createTestData;
